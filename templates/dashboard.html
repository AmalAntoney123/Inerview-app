<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - SkillSpeak</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
</head>
<body>
    <!-- Sidebar -->
    {% set sidebar_title = 'User Dashboard' %}
    {% set active_page = 'dashboard' %}
    {% include 'sidebar.html' %}

    <!-- Main Content -->
    <div class="main-content">
        <div class="header fade-in">
            <h1>Welcome back, {{ user.fullname if user.fullname else 'User' }}!</h1>
            <div class="user-info">
                <div class="user-avatar">
                    {% if user.profile_image %}
                        <img src="{{ url_for('static', filename='uploads/' + user.profile_image) }}" alt="Profile Image">
                    {% else %}
                        {{ user.fullname[0] if user.fullname else 'U' }}
                    {% endif %}
                </div>
                <span>{{ user.fullname if user.fullname else 'User' }}</span>
            </div>
        </div>

        <!-- Floating Action Button for New Interview -->
        <button class="fab" title="Start New Interview" onclick="openInterviewModal()">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- Bottom Navigation for Mobile -->
    <!-- Interview Setup Modal -->
    <div id="interviewModal" class="modal-overlay" style="display:none;">
        <div class="modal-content-wrapper">
            <button class="modal-close-btn" onclick="closeInterviewModal()">&times;</button>
            <h2 class="interview-setup-title">Ready to Practice?</h2>
            <p class="interview-setup-desc">Configure your custom interview session. Our AI will simulate a real hiring manager based on your input.</p>
            
            <form id="interviewSetupForm" class="interview-setup-form" onsubmit="submitInterviewForm(event)">
                <div class="interview-setup-grid">
                    <div class="interview-setup-field">
                        <label class="interview-setup-label">Target Role</label>
                        <input
                            type="text"
                            id="interviewRole"
                            class="interview-setup-input"
                            placeholder="e.g. Product Manager"
                            value="Software Engineer"
                            required
                        />
                    </div>
                    <div class="interview-setup-field">
                        <label class="interview-setup-label">Experience Level</label>
                        <select id="interviewLevel" class="interview-setup-select">
                            <option>Intern</option>
                            <option>Junior</option>
                            <option>Mid-level</option>
                            <option selected>Senior</option>
                            <option>Staff/Principal</option>
                        </select>
                    </div>
                </div>

                <div class="interview-setup-field">
                    <label class="interview-setup-label">Target Company</label>
                    <input
                        type="text"
                        id="interviewCompany"
                        class="interview-setup-input"
                        placeholder="e.g. Amazon"
                        value="Google"
                        required
                    />
                </div>

                <div class="interview-setup-field">
                    <label class="interview-setup-label">Interview Focus / Context</label>
                    <textarea
                        id="interviewDescription"
                        class="interview-setup-textarea"
                        placeholder="Paste the job description or specific areas you want to cover..."
                    >General system design and behavioral interview.</textarea>
                </div>

                <button type="submit" class="interview-setup-submit">
                    Start Mock Interview
                </button>
            </form>
        </div>
    </div>

    <script>
        // Modal logic
        function openInterviewModal() {
            const modal = document.getElementById('interviewModal');
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }
        
        function closeInterviewModal() {
            const modal = document.getElementById('interviewModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
        }
        
        // Handle form submit
        async function submitInterviewForm(event) {
            event.preventDefault();
            
            // Get form data
            const formData = {
                role: document.getElementById('interviewRole').value,
                level: document.getElementById('interviewLevel').value,
                company: document.getElementById('interviewCompany').value,
                description: document.getElementById('interviewDescription').value
            };
            
            try {
                // Start interview session via backend
                const response = await fetch('/api/interview/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Store in sessionStorage to pass to interview page
                    sessionStorage.setItem('interviewSession', JSON.stringify(formData));
                    
                    // Redirect to interview page
                    closeInterviewModal();
                    window.location.href = "{{ url_for('user.interview') }}";
                } else {
                    alert('Failed to start interview. Please try again.');
                }
            } catch (error) {
                console.error('Error starting interview:', error);
                alert('Error starting interview. Please try again.');
            }
        }
        
        // Only close modal if clicking overlay, not modal content
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('interviewModal');
            if (modal) {
                modal.addEventListener('mousedown', function(e) {
                    if (e.target === this) closeInterviewModal();
                });
            }
            
            // Escape key closes modal
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') closeInterviewModal();
            });
        });

    </script>
</body>
</html>