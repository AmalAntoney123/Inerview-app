<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Settings - SkillSpeak</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
</head>
<body>
    {% set sidebar_title = 'User Dashboard' %}
    {% set active_page = 'profile' %}
    {% include 'sidebar.html' %}

    <!-- Main Content -->
    <div class="main-content">
        <div class="header fade-in">
            <h1>Profile Settings</h1>
            <div class="user-info">
                <div class="user-avatar">
                    {% if user.profile_image %}
                        <img src="{{ url_for('static', filename='uploads/' + user.profile_image) }}" alt="Profile Image">
                    {% else %}
                        {{ user.fullname[0] if user.fullname else 'U' }}
                    {% endif %}
                </div>
                <span>{{ user.fullname if user.fullname else 'User' }}</span>
            </div>
        </div>

        <div class="profile-container fade-in">
            <!-- Profile Sidebar -->
            <div class="profile-sidebar">
                <div class="profile-avatar-container">
                    <div class="profile-avatar" id="profileAvatar">
                        {% if user.profile_image %}
                            <img src="{{ url_for('static', filename='uploads/' + user.profile_image) }}" alt="Profile Image">
                        {% else %}
                            {{ user.fullname[0] if user.fullname else 'U' }}
                        {% endif %}
                    </div>
                    <button class="avatar-upload" onclick="document.getElementById('profileImageInput').click()">
                        <i class="fas fa-camera"></i>
                        <input type="file" id="profileImageInput" accept="image/*" onchange="previewImage(this)">
                    </button>
                </div>
                <div class="profile-name">{{ user.fullname if user.fullname else 'User' }}</div>
                <div class="profile-email">{{ user.email }}</div>

                <div class="profile-stats">
                    {% if user.email == 'admin@gmail.com' %}
                    <div class="stat-item">
                        <span class="stat-number">{{ stats.users_managed if stats and stats.users_managed else 0 }}</span>
                        <span class="stat-label">Users</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">{{ stats.system_health if stats and stats.system_health else 'Good' }}</span>
                        <span class="stat-label">System</span>
                    </div>
                    {% else %}
                    <div class="stat-item">
                        <span class="stat-number">{{ stats.interviews_completed if stats else 0 }}</span>
                        <span class="stat-label">Interviews</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">{{ "%.1f"|format(stats.average_score) if stats else "0.0" }}</span>
                        <span class="stat-label">Avg Score</span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Profile Main Content -->
            <div class="profile-main">
                <div class="profile-tabs">
                    <button class="profile-tab active" onclick="switchTab('personal')">Personal Info</button>
                    <button class="profile-tab" onclick="switchTab('security')">Security</button>
                </div>

                <!-- Personal Info Tab -->
                <div id="personal" class="tab-content tab-pane active">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ 'success' if category == 'success' else 'error' }}">
                                    <i class="fas fa-{{ 'check-circle' if category == 'success' else 'exclamation-circle' }}"></i>
                                    {{ message }}
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <form method="POST" action="{{ url_for('user.update_profile') }}" enctype="multipart/form-data">
                        <input type="hidden" name="form_type" value="personal">
                        <input type="file" id="profileImageInput" name="profile_image" accept="image/*" style="display: none;">
                        <div class="form-section">
                            <h3><i class="fas fa-user"></i> Personal Information</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="fullname">Full Name</label>
                                    <input type="text" id="fullname" name="fullname" value="{{ user.fullname }}" required>
                                </div>
                                <div class="form-group">
                                    <label for="phone">Phone Number</label>
                                    <input type="tel" id="phone" value="{{ user.phone }}" readonly style="background-color: #f8f9fa; cursor: not-allowed;">
                                    <small style="color: #666; font-size: 12px;">Contact support to change phone number</small>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="email">Email Address</label>
                                <input type="email" id="email" value="{{ user.email }}" readonly style="background-color: #f8f9fa; cursor: not-allowed;">
                                <small style="color: #666; font-size: 12px;">Email cannot be changed. Contact support if needed.</small>
                            </div>
                            <div class="form-group">
                                <label for="bio">Bio</label>
                                <textarea id="bio" name="bio" placeholder="Tell us about yourself...">{{ user.bio if user.bio else '' }}</textarea>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </form>
                </div>

                <!-- Security Tab -->
                <div id="security" class="tab-content tab-pane">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ 'success' if category == 'success' else 'error' }}">
                                    <i class="fas fa-{{ 'check-circle' if category == 'success' else 'exclamation-circle' }}"></i>
                                    {{ message }}
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <form method="POST" action="{{ url_for('user.change_password') }}" onsubmit="return validatePassword()">
                        <input type="hidden" name="form_type" value="password">
                        <div class="form-section">
                            <h3><i class="fas fa-lock"></i> Change Password</h3>
                            <div class="form-group">
                                <label for="current_password">Current Password</label>
                                <input type="password" id="current_password" name="current_password" required>
                            </div>
                            <div class="form-group">
                                <label for="new_password">New Password</label>
                                <input type="password" id="new_password" name="new_password" required onkeyup="checkPasswordStrength()">
                                <div id="passwordStrength" class="password-strength"></div>
                            </div>
                            <div class="form-group">
                                <label for="confirm_password">Confirm New Password</label>
                                <input type="password" id="confirm_password" name="confirm_password" required>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-key"></i> Change Password
                        </button>
                    </form>

                    <div class="form-section " style="margin-top: 40px;">
                        <h3><i class="fas fa-shield-alt"></i> Account Management</h3>
                        <p style="color: #666; margin-bottom: 20px;">Manage your account settings and security options.</p>
                        
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <a href="{{ url_for('user.logout') }}" class="btn btn-danger" style="text-decoration: none;">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </a>
                            <button type="button" class="btn btn-secondary" onclick="confirmDelete()">
                                <i class="fas fa-trash-alt"></i> Delete Account
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Confirmation Modal -->
    <div id="imageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Profile Picture</h3>
                <span class="modal-close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="image-preview-container">
                    <img id="modalImagePreview" src="" alt="Image Preview">
                </div>
                <p>Do you want to use this image as your profile picture?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmImage()">Save Picture</button>
            </div>
        </div>
    </div>
    {% include 'bottom_nav.html' %}

    <script>
        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab panes
            const tabPanes = document.querySelectorAll('.tab-pane');
            tabPanes.forEach(pane => pane.classList.remove('active'));

            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.profile-tab');
            tabButtons.forEach(button => button.classList.remove('active'));

            // Show selected tab pane
            document.getElementById(tabName).classList.add('active');

            // Add active class to clicked button
            event.target.classList.add('active');
        }

        // Image preview functionality
        let selectedImageFile = null;

        function previewImage(input) {
            if (input.files && input.files[0]) {
                selectedImageFile = input.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Show modal with image preview
                    document.getElementById('modalImagePreview').src = e.target.result;
                    document.getElementById('imageModal').style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function closeModal() {
            document.getElementById('imageModal').style.display = 'none';
            selectedImageFile = null;
            // Reset file input
            document.getElementById('profileImageInput').value = '';
        }

        function confirmImage() {
            if (selectedImageFile) {
                // Create a new FormData object to handle the file upload
                const formData = new FormData();
                formData.append('form_type', 'personal');
                formData.append('profile_image', selectedImageFile);

                // Add other form fields
                const form = document.querySelector('form[action*="update_profile"]');
                const formInputs = form.querySelectorAll('input[name], textarea[name], select[name]');
                formInputs.forEach(input => {
                    if (input.name && input.name !== 'profile_image' && input.type !== 'file') {
                        formData.append(input.name, input.value);
                    }
                });

                // Send the form data via AJAX
                fetch(form.action, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        // Update the avatar with the selected image
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const avatar = document.getElementById('profileAvatar');
                            avatar.innerHTML = `<img src="${e.target.result}" alt="Profile Image">`;
                        };
                        reader.readAsDataURL(selectedImageFile);

                        // Show success message
                        showMessage('Profile picture updated successfully!', 'success');
                    } else {
                        showMessage('Failed to update profile picture. Please try again.', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage('An error occurred. Please try again.', 'error');
                });

                // Close modal
                closeModal();
            }
        }

        function showMessage(message, type) {
            // Remove existing messages
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());

            // Create new message
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'error'}`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                ${message}
            `;

            // Insert at the top of the personal info section
            const personalTab = document.getElementById('personal');
            personalTab.insertBefore(alertDiv, personalTab.firstChild);

            // Auto-hide after 5 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('imageModal');
            if (event.target == modal) {
                closeModal();
            }
        }

        // Password strength checker
        function checkPasswordStrength() {
            const password = document.getElementById('new_password').value;
            const strengthIndicator = document.getElementById('passwordStrength');

            let strength = 0;
            let feedback = [];

            if (password.length >= 8) strength++;
            else feedback.push("At least 8 characters");

            if (/[a-z]/.test(password)) strength++;
            else feedback.push("Lowercase letter");

            if (/[A-Z]/.test(password)) strength++;
            else feedback.push("Uppercase letter");

            if (/[0-9]/.test(password)) strength++;
            else feedback.push("Number");

            if (/[^A-Za-z0-9]/.test(password)) strength++;
            else feedback.push("Special character");

            switch(strength) {
                case 0:
                case 1:
                    strengthIndicator.innerHTML = '<span class="strength-weak">Weak password</span>';
                    break;
                case 2:
                case 3:
                    strengthIndicator.innerHTML = '<span class="strength-medium">Medium strength</span>';
                    break;
                case 4:
                case 5:
                    strengthIndicator.innerHTML = '<span class="strength-strong">Strong password</span>';
                    break;
            }
        }

        // Password validation
        function validatePassword() {
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;

            if (newPassword !== confirmPassword) {
                alert('Passwords do not match!');
                return false;
            }

            if (newPassword.length < 8) {
                alert('Password must be at least 8 characters long!');
                return false;
            }

            return true;
        }

        // Enable 2FA (placeholder)
        function enable2FA() {
            alert('2FA setup would be implemented here with QR code generation and verification.');
        }

        // Confirm account deletion
        function confirmDelete() {
            if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                // Redirect to delete account endpoint
                window.location.href = '{{ url_for("user.delete_account") }}';
            }
        }

        // Add fade-in animation on scroll
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('fade-in');
                }
            });
        }, observerOptions);

        document.querySelectorAll('.fade-in').forEach(el => {
            observer.observe(el);
        });

        // Mobile bottom nav active state
        document.querySelectorAll('.bottom-nav-menu a').forEach(link => {
            link.addEventListener('click', function(e) {
                document.querySelectorAll('.bottom-nav-menu a').forEach(a => a.classList.remove('active'));
                this.classList.add('active');
            });
        });
    </script>
</body>
</html>